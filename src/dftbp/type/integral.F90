!--------------------------------------------------------------------------------------------------!
!  DFTB+: general package for performing fast atomistic simulations                                !
!  Copyright (C) 2006 - 2021  DFTB+ developers group                                               !
!                                                                                                  !
!  See the LICENSE file for terms of usage and distribution.                                       !
!--------------------------------------------------------------------------------------------------!

#:include 'common.fypp'

!> Data types to handle overlap related integrals
module dftbp_type_integral
  use dftbp_common_accuracy, only : dp
  implicit none

  private
  public :: TIntegral, TIntegral_init


  !> Container to store overlap related integrals
  type :: TIntegral

    !> Overlap integrals in atomic block sparse form
    real(dp), allocatable :: overlap(:)

    !> Dipole integrals with operator on ket function
    real(dp), allocatable :: dipoleKet(:, :)

    !> Dipole integrals with operator on bra function
    real(dp), allocatable :: dipoleBra(:, :)

    !> Quadrupole integrals with operator on ket function
    real(dp), allocatable :: quadrupoleKet(:, :)

    !> Quadrupole integrals with operator on bra function
    real(dp), allocatable :: quadrupoleBra(:, :)

    !> Real Hamiltonian integrals in atomic block sparse form
    real(dp), allocatable :: hamiltonian(:, :)

    !> Imaginary Hamiltonian integrals in atomic block sparse form
    real(dp), allocatable :: iHamiltonian(:, :)

  #:if WITH_SCALAPACK

    !> Atoms corresponding to local columns of the orbital grid for dense matrix stored integrals
    integer, allocatable :: lowerTriangleLocalAtoms(:)

    !> Atoms corresponding to ocal rows of the orbital grid for dense matrix stored integrals
    integer, allocatable :: bothTriangleLocalAtoms(:)

  #:endif

  end type TIntegral


contains


  !> Initializier for integral container
  subroutine TIntegral_init(this, nSpin, tReHam, tImHam, nDipole, nQuadrupole)

    !> Instance of the integral container
    type(TIntegral), intent(out) :: this

    !> Number of spins channels in the system
    integer, intent(in) :: nSpin

    !> Allocate space for real Hamiltonian
    logical, intent(in) :: tReHam

    !> Allocate space for imaginary Hamiltonian
    logical, intent(in) :: tImHam

    !> Number of dipole moment components included
    integer, intent(in) :: nDipole

    !> Number of quadrupole moment components included
    integer, intent(in) :: nQuadrupole

    if (tReHam) then
      allocate(this%hamiltonian(0, nSpin))
    end if
    if (tImHam) then
      allocate(this%iHamiltonian(0, nSpin))
    end if
    allocate(this%overlap(0))
    if (nDipole > 0) then
      allocate(this%dipoleKet(nDipole, 0))
      allocate(this%dipoleBra(nDipole, 0))
    end if
    if (nQuadrupole > 0) then
      allocate(this%quadrupoleKet(nQuadrupole, 0))
      allocate(this%quadrupoleBra(nQuadrupole, 0))
    end if

  #:if WITH_SCALAPACK
    allocate(this%lowerTriangleLocalAtoms(0))
    allocate(this%bothTriangleLocalAtoms(0))
  #:endif

  end subroutine TIntegral_init


end module dftbp_type_integral
